# ç«™ç‚¹ç­›é€‰è§„åˆ™æœªç”Ÿæ•ˆé—®é¢˜åˆ†ææŠ¥å‘Š

## é—®é¢˜æè¿°

è‡ªåŠ¨åŒæ­¥æ‰¹æ¬¡æ£€æµ‹äº† 1253 ä¸ª SKUï¼ˆå…¨éƒ¨ SKUï¼‰ï¼Œä½†ç«™ç‚¹é…ç½®äº†ç­›é€‰è§„åˆ™åº”è¯¥åªæ£€æµ‹çº¦ 200 ä¸ª SKUã€‚æ‰€æœ‰ 1253 ä¸ª SKU éƒ½è¢«è·³è¿‡ï¼ˆskippedï¼‰ï¼Œæ²¡æœ‰å®é™…åŒæ­¥æ“ä½œã€‚

## å½“å‰é…ç½®çŠ¶æ€

```
ç«™ç‚¹: Vapsolowholes
  SKUç­›é€‰: (æ— )
  æ’é™¤å‰ç¼€: JNR,VS5-,VS2-,HO,AK,YP-,RMTD,24PM,KPV,MA0,UK-,US-,VOL,FX,FL,ADY,VI,TRP3,TRP0,QU0,kp2,kp5,zhixiang,TW2-24-SI-MPW,TW2-11-LL-WI
  åˆ†ç±»ç­›é€‰: 0 ä¸ª
  æ’é™¤ä»“åº“: æ·±åœ³,å¾·äº”ï¼Œç¾ä¸€ä»“ï¼Œç‹¬ç«‹ç«™å¤‡è´§ä»“
```

é…ç½®å­˜å‚¨åœ¨ `site_filters` è¡¨ä¸­ï¼Œå­—æ®µä¸º:
- `exclude_sku_prefixes`
- `exclude_warehouses`

## å…³é”®ä»£ç æµç¨‹åˆ†æ

### 1. æ­¥éª¤ 0 (dispatcher/route.ts) - æ•°æ®ç¼“å­˜

**æ–‡ä»¶**: `src/app/api/sync/dispatcher/route.ts`
**å‡½æ•°**: `executeStep0()`

```
ç¬¬ 181-191 è¡Œ:
let inventoryData: InventoryItem[] = transformResult.data;
console.log(`[Dispatcher ${logId}] è½¬æ¢å ${inventoryData.length} æ¡åº“å­˜è®°å½•`);

// 4. åˆå¹¶ä»“åº“ï¼ˆå…¨å±€è®¾ç½®ï¼‰
// æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåº”ç”¨ç«™ç‚¹ç‰¹å®šçš„ç­›é€‰ï¼ˆSKUç­›é€‰ã€æ’é™¤å‰ç¼€ã€æ’é™¤ä»“åº“ï¼‰
// è¿™äº›ç­›é€‰ç”±å„ç«™ç‚¹åœ¨æ­¥éª¤1-Næ—¶æ ¹æ®è‡ªå·±çš„ site_filters é…ç½®åº”ç”¨
if (filters.isMergedMode) {
  inventoryData = mergeWarehouseData(inventoryData);
  console.log(`[Dispatcher ${logId}] åˆå¹¶ä»“åº“å ${inventoryData.length} æ¡`);
}
```

**åˆ†æ**: æ­¥éª¤ 0 æ­£ç¡®åœ°åªåšäº†ä»“åº“åˆå¹¶ï¼Œæ²¡æœ‰åº”ç”¨ç«™ç‚¹ç­›é€‰ã€‚ç¼“å­˜çš„æ˜¯å®Œæ•´çš„ 1253 æ¡æ•°æ®ã€‚

### 2. æ­¥éª¤ 1 (site/route.ts) - ç«™ç‚¹åŒæ­¥

**æ–‡ä»¶**: `src/app/api/sync/site/route.ts`

#### 2.1 è·å–ç«™ç‚¹ç­›é€‰é…ç½® (ç¬¬ 276-317 è¡Œ)

```typescript
// 4. è·å–ç«™ç‚¹ä¿¡æ¯ï¼ˆåŒ…å«ç­›é€‰é…ç½®ï¼‰
const { data: siteData, error: siteError } = await supabase
  .from('wc_sites')
  .select(`
    id, name, url, api_key, api_secret,
    site_filters (
      sku_filter,
      exclude_sku_prefixes,
      category_filters,
      exclude_warehouses
    )
  `)
  .eq('id', siteResult.site_id)
  .single();

// è½¬æ¢ç«™ç‚¹æ•°æ®
const filterArr = (siteData as any).site_filters as SiteFilterInfo[] | null;
const site: SiteInfo = {
  ...
  site_filters: (filterArr && filterArr.length > 0) ? (filterArr[0] ?? null) : null,
};
```

**âš ï¸ æ½œåœ¨é—®é¢˜ 1**: Supabase çš„ JOIN æŸ¥è¯¢è¿”å›çš„ `site_filters` å¯èƒ½æ˜¯å¯¹è±¡è€Œä¸æ˜¯æ•°ç»„ã€‚ä»£ç å‡è®¾å®ƒæ˜¯æ•°ç»„ (`filterArr[0]`)ï¼Œå¦‚æœå®é™…æ˜¯å¯¹è±¡ï¼Œåˆ™ä¼šè·å–ä¸åˆ°ç­›é€‰é…ç½®ã€‚

#### 2.2 åˆå¹¶ç­›é€‰é…ç½® (ç¬¬ 334-357 è¡Œ)

```typescript
const siteSpecificFilters = site.site_filters;
const siteFilters: FilterConfig = {
  // ä½¿ç”¨å…¨å±€æ˜¾ç¤ºé…ç½®
  isMergedMode: globalFilters.isMergedMode,
  hideZeroStock: globalFilters.hideZeroStock,
  hideNormalStatus: globalFilters.hideNormalStatus,
  showNeedSync: globalFilters.showNeedSync,
  categoryFilter: globalFilters.categoryFilter,
  // ä½¿ç”¨ç«™ç‚¹ç‰¹å®šçš„ç­›é€‰é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
  skuFilter: siteSpecificFilters?.sku_filter || '',
  excludeSkuPrefixes: siteSpecificFilters?.exclude_sku_prefixes || '',
  categoryFilters: siteSpecificFilters?.category_filters || [],
  excludeWarehouses: siteSpecificFilters?.exclude_warehouses || '',
};

console.log(`[Site Sync ${logId}] ç«™ç‚¹ ${site.name} ä½¿ç”¨ç«™ç‚¹ç‰¹å®šç­›é€‰é…ç½®:`, {
  skuFilter: siteFilters.skuFilter ? `"${siteFilters.skuFilter.substring(0, 50)}..."` : '(æ— )',
  excludeSkuPrefixes: siteFilters.excludeSkuPrefixes ? `"${siteFilters.excludeSkuPrefixes.substring(0, 50)}..."` : '(æ— )',
  categoryFilters: siteFilters.categoryFilters?.length || 0,
  excludeWarehouses: siteFilters.excludeWarehouses ? `"${siteFilters.excludeWarehouses.substring(0, 50)}..."` : '(æ— )',
});
```

**åˆ†æ**: å¦‚æœ `site.site_filters` ä¸º nullï¼ˆç”±äºä¸Šé¢çš„é—®é¢˜ï¼‰ï¼Œæ‰€æœ‰ç­›é€‰é…ç½®éƒ½ä¼šæ˜¯ç©ºå­—ç¬¦ä¸²ã€‚

#### 2.3 ç­›é€‰å‡½æ•° (ç¬¬ 82-150 è¡Œ)

```typescript
function filterInventoryData(data: InventoryItem[], filters: FilterConfig): InventoryItem[] {
  const { skuFilter, categoryFilter, categoryFilters, hideZeroStock, excludeSkuPrefixes, excludeWarehouses } = filters;

  let excludedByWarehouse = 0;
  let excludedBySkuPrefix = 0;

  const filtered = data.filter(item => {
    // ä»“åº“æ’é™¤
    if (excludeWarehouses?.trim()) {
      const excludeList = excludeWarehouses.split(/[,ï¼Œ\n]/).map(s => s.trim()).filter(s => s);
      if (excludeList.some(warehouse => {
        const itemWarehouse = (item.ä»“åº“ || '').trim();
        const excludeWarehouse = warehouse.trim();
        return itemWarehouse === excludeWarehouse || itemWarehouse.includes(excludeWarehouse);
      })) {
        excludedByWarehouse++;
        return false;
      }
    }

    // SKUå‰ç¼€æ’é™¤
    if (excludeSkuPrefixes?.trim()) {
      const excludeList = excludeSkuPrefixes.split(/[,ï¼Œ\n]/).map(s => s.trim()).filter(s => s);
      if (excludeList.some(prefix => item.äº§å“ä»£ç .toLowerCase().startsWith(prefix.toLowerCase()))) {
        excludedBySkuPrefix++;
        return false;
      }
    }
    ...
  });

  console.log(`[Filter] åŸå§‹: ${data.length} æ¡ â†’ ç­›é€‰å: ${filtered.length} æ¡ (ä»“åº“æ’é™¤: ${excludedByWarehouse}, SKUå‰ç¼€æ’é™¤: ${excludedBySkuPrefix})`);

  return filtered;
}
```

**åˆ†æ**: ç­›é€‰é€»è¾‘æœ¬èº«æ˜¯æ­£ç¡®çš„ã€‚å¦‚æœ `excludeWarehouses` å’Œ `excludeSkuPrefixes` æœ‰å€¼ï¼Œä¼šæ­£ç¡®æ’é™¤ã€‚

#### 2.4 ç»Ÿè®¡æ•°æ®æ¥æº (ç¬¬ 425 è¡Œ)

```typescript
let totalChecked = h3yunSkus.length;
```

`h3yunSkus` æ¥è‡ªç¬¬ 370 è¡Œ:
```typescript
const h3yunSkus = siteInventoryData.map(item => item.äº§å“ä»£ç );
```

`siteInventoryData` æ¥è‡ªç¬¬ 361 è¡Œ:
```typescript
const siteInventoryData = filterInventoryData(inventoryData, siteFilters);
```

**åˆ†æ**: `totalChecked` åº”è¯¥æ˜¯ç­›é€‰åçš„æ•°é‡ã€‚å¦‚æœæ˜¾ç¤º 1253ï¼Œè¯´æ˜ç­›é€‰æ²¡æœ‰ç”Ÿæ•ˆã€‚

---

## ğŸ”´ æ ¹æœ¬é—®é¢˜å®šä½

### é—®é¢˜åœ¨ç¬¬ 309 è¡Œå’Œç¬¬ 316 è¡Œ:

```typescript
// ç¬¬ 309 è¡Œ
const filterArr = (siteData as any).site_filters as SiteFilterInfo[] | null;

// ç¬¬ 316 è¡Œ
site_filters: (filterArr && filterArr.length > 0) ? (filterArr[0] ?? null) : null,
```

**Supabase JOIN æŸ¥è¯¢çš„è¿”å›å€¼é—®é¢˜**:

å½“ä½¿ç”¨ Supabase çš„åµŒå¥— select æŸ¥è¯¢æ—¶:
```sql
SELECT id, name, url, site_filters (sku_filter, exclude_sku_prefixes, ...)
FROM wc_sites WHERE id = ?
```

è¿”å›çš„ `site_filters` å¯èƒ½æ˜¯:
1. **å•ä¸ªå¯¹è±¡** (ä¸€å¯¹ä¸€å…³ç³»): `{ sku_filter: "...", exclude_sku_prefixes: "...", ... }`
2. **æ•°ç»„** (ä¸€å¯¹å¤šå…³ç³»): `[{ sku_filter: "...", ... }]`
3. **null** (æ²¡æœ‰å…³è”è®°å½•)

ä»£ç å‡è®¾æ˜¯**æ•°ç»„**ï¼Œä½†å®é™…ä¸Š `wc_sites` å’Œ `site_filters` æ˜¯**ä¸€å¯¹ä¸€å…³ç³»**ï¼Œè¿”å›çš„åº”è¯¥æ˜¯**å•ä¸ªå¯¹è±¡**ã€‚

å½“ `filterArr` æ˜¯å¯¹è±¡ `{ sku_filter: "...", ... }` æ—¶:
- `filterArr.length` æ˜¯ `undefined`ï¼ˆå¯¹è±¡æ²¡æœ‰ length å±æ€§ï¼‰
- `filterArr && filterArr.length > 0` ä¸º `false`
- ç»“æœ: `site.site_filters = null`

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç«™ç‚¹ç­›é€‰é…ç½®æ²¡æœ‰è¢«è¯»å–åˆ°ï¼**

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ `src/app/api/sync/site/route.ts` ç¬¬ 309-317 è¡Œ:

**å½“å‰ä»£ç **:
```typescript
const filterArr = (siteData as any).site_filters as SiteFilterInfo[] | null;
const site: SiteInfo = {
  id: siteData.id,
  name: siteData.name,
  url: siteData.url,
  api_key: siteData.api_key,
  api_secret: siteData.api_secret,
  site_filters: (filterArr && filterArr.length > 0) ? (filterArr[0] ?? null) : null,
};
```

**ä¿®å¤åä»£ç **:
```typescript
// site_filters å¯èƒ½æ˜¯å¯¹è±¡ï¼ˆä¸€å¯¹ä¸€ï¼‰æˆ–æ•°ç»„ï¼ˆä¸€å¯¹å¤šï¼‰æˆ– null
const rawFilters = (siteData as any).site_filters;
let siteFilterInfo: SiteFilterInfo | null = null;

if (rawFilters) {
  if (Array.isArray(rawFilters)) {
    // ä¸€å¯¹å¤šå…³ç³»ï¼Œå–ç¬¬ä¸€ä¸ª
    siteFilterInfo = rawFilters.length > 0 ? rawFilters[0] : null;
  } else {
    // ä¸€å¯¹ä¸€å…³ç³»ï¼Œç›´æ¥ä½¿ç”¨å¯¹è±¡
    siteFilterInfo = rawFilters as SiteFilterInfo;
  }
}

const site: SiteInfo = {
  id: siteData.id,
  name: siteData.name,
  url: siteData.url,
  api_key: siteData.api_key,
  api_secret: siteData.api_secret,
  site_filters: siteFilterInfo,
};
```

---

## éªŒè¯æ­¥éª¤

1. ä¿®å¤ä»£ç åæ¨é€åˆ° `origin` (shen963789/restore-analysis.git)
2. ç­‰å¾… Vercel éƒ¨ç½²ï¼ˆ1-2 åˆ†é’Ÿï¼‰
3. æŸ¥çœ‹ Vercel æ—¥å¿—ç¡®è®¤å‡ºç° `[Filter]` æ—¥å¿—
4. æ£€æŸ¥ä¸‹ä¸€ä¸ªæ‰¹æ¬¡çš„ SKU æ•°é‡æ˜¯å¦é™åˆ° 200-250

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `src/app/api/sync/dispatcher/route.ts` | æ­¥éª¤ 0: æ‹‰å– ERP æ•°æ®å¹¶ç¼“å­˜ |
| `src/app/api/sync/site/route.ts` | æ­¥éª¤ 1-N: è¯»å–ç¼“å­˜ï¼Œåº”ç”¨ç«™ç‚¹ç­›é€‰ï¼Œæ‰§è¡ŒåŒæ­¥ |
| `src/app/auto-sync/page.tsx` | å‰ç«¯é…ç½®é¡µé¢ |
| `src/app/api/sync/site-filters/route.ts` | ä¿å­˜ç«™ç‚¹ç­›é€‰é…ç½® API |

---

## æ•°æ®åº“è¡¨

| è¡¨å | ä½œç”¨ |
|------|------|
| `wc_sites` | ç«™ç‚¹ä¿¡æ¯ï¼ˆid, name, url, api_key, api_secretï¼‰ |
| `site_filters` | ç«™ç‚¹ç­›é€‰é…ç½®ï¼ˆsite_id, sku_filter, exclude_sku_prefixes, exclude_warehousesï¼‰ |
| `auto_sync_config` | å…¨å±€è‡ªåŠ¨åŒæ­¥é…ç½® |
| `sync_batches` | åŒæ­¥æ‰¹æ¬¡çŠ¶æ€ |
| `sync_site_results` | ç«™ç‚¹åŒæ­¥ç»“æœï¼ˆåŒ…å« total_checked, skipped ç­‰ç»Ÿè®¡ï¼‰ |
| `inventory_cache` | ç¼“å­˜çš„åº“å­˜æ•°æ® |

---

## æ€»ç»“

**æ ¹æœ¬åŸå› **: Supabase JOIN æŸ¥è¯¢è¿”å›çš„ `site_filters` æ˜¯**å•ä¸ªå¯¹è±¡**ï¼Œä½†ä»£ç é”™è¯¯åœ°å°†å…¶å½“ä½œ**æ•°ç»„**å¤„ç†ï¼Œå¯¼è‡´ `filterArr.length` ä¸º `undefined`ï¼Œæœ€ç»ˆ `site.site_filters` è¢«è®¾ä¸º `null`ã€‚

**ç»“æœ**: ç«™ç‚¹ç­›é€‰é…ç½®ï¼ˆ`excludeWarehouses`ã€`excludeSkuPrefixes`ï¼‰ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œç­›é€‰å‡½æ•°ä¸æ‰§è¡Œä»»ä½•è¿‡æ»¤ï¼Œ1253 æ¡æ•°æ®å…¨éƒ¨é€šè¿‡ã€‚
