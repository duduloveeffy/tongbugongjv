# 全量数据同步说明

## 概述
初始数据同步按钮（数据库图标）执行的是**全量同步**，会同步站点的所有数据。

## 同步模式对比

### 全量同步 (Full Sync) - 初始同步按钮
- **模式**: `mode: 'full'`
- **订单范围**: 所有订单，不限时间
- **产品范围**: 所有产品和变体
- **使用场景**:
  - 首次连接站点
  - 数据修复
  - 重新同步所有数据

### 增量同步 (Incremental Sync) - 增量按钮
- **模式**: `mode: 'incremental'`
- **订单范围**: 只同步上次同步后修改的订单
- **产品范围**: 只同步上次同步后修改的产品
- **使用场景**:
  - 日常数据更新
  - 快速同步最新变化

## 全量同步技术细节

### 订单同步
```javascript
// 全量模式不添加时间过滤
if (mode === 'incremental' && checkpoint?.last_order_modified) {
  params.append('modified_after', lastModified.toISOString());
}
// mode === 'full' 时不添加 modified_after，获取所有订单
```

**参数配置**:
- 每页数量: 100 个订单
- 批处理大小: 30 个订单/批
- 最大页数: 无限制 (999999)
- 超时时间: 60 分钟
- 排序方式: 按修改时间升序

### 产品同步
**参数配置**:
- 批处理大小: 20 个产品/批
- 包含变体: 是
- 超时时间: 10 分钟

## 性能优化

### 1. 去重机制
- **API层去重**: 防止跨页面重复
- **批处理去重**: 防止批次内重复

### 2. 错误处理
- 数值溢出自动跳过
- 502错误自动重试
- 失败订单记录但不中断

### 3. 进度追踪
- 实时更新 `sync_tasks` 表
- 前端每5秒查询进度
- 10分钟后自动停止轮询

## 数据处理流程

```
1. 用户点击全量同步按钮
   ↓
2. 创建异步任务 (立即返回)
   ↓
3. 后台开始同步
   ├── 订单同步 (全部订单)
   │   ├── 按页获取 (100/页)
   │   ├── 批量插入 (30/批)
   │   └── 更新进度
   │
   └── 产品同步 (全部产品)
       ├── 按页获取
       ├── 批量插入 (20/批)
       └── 更新进度
   ↓
4. 同步完成，更新状态
```

## 注意事项

1. **大数据量站点**
   - 16,000+ 订单预计需要 5-10 分钟
   - 建议在非高峰时段执行

2. **数据覆盖**
   - 全量同步会更新所有已存在的数据
   - 使用 UPSERT 确保数据最新

3. **并发控制**
   - 同一站点同时只能有一个同步任务
   - 避免重复同步导致冲突

## 使用建议

1. **首次使用**: 执行全量同步建立基础数据
2. **日常维护**: 使用增量同步更新变化
3. **数据异常**: 使用全量同步修复数据
4. **定期校验**: 每月执行一次全量同步确保数据完整性