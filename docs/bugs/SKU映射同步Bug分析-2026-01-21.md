# SKU一对多映射同步Bug分析

**日期**: 2026-01-21
**严重程度**: 高
**状态**: 待修复

---

## 问题描述

### 现象

| SKU | ERP库存 | WC实际库存 | Supabase库存 | 状态 |
|-----|---------|-----------|--------------|------|
| kp-20 (主SKU) | 0 | - | - | - |
| kp2-20 (映射) | - | 0 (无货) | 0 (无货) | ✓ 正确 |
| kp5-20 (映射) | - | 4 (有货) | 0 (无货) | ✗ 错误 |

**异常**:
- ERP库存为0，应该把所有映射的WC SKU都同步为无货
- kp2-20 正确同步为无货
- **kp5-20 没有被同步**，WC仍显示有货（库存4）

---

## 根因分析

### 问题代码位置

**文件**: `src/app/api/sync/auto/route.ts` 第577-584行

```typescript
// 将检测结果映射回氚云 SKU
// 如果一个氚云 SKU 对应多个 WooCommerce SKU，取第一个有效结果
const productStatus = new Map<string, { stockStatus: string; isOnline: boolean }>();
for (const [wooSku, status] of productStatusRaw.entries()) {
  const h3yunSku = skuDetectionMap.get(wooSku);
  if (h3yunSku && !productStatus.has(h3yunSku)) {  // ⚠️ BUG在这里
    productStatus.set(h3yunSku, status);
  }
}
```

### 问题逻辑流程

```
1. kp-20 (氚云SKU) 映射到 kp2-20 和 kp5-20 (WooCommerce SKU)

2. 检测阶段：
   - 检测 kp2-20 → stockStatus: 'outofstock'
   - 检测 kp5-20 → stockStatus: 'instock'

3. 映射回氚云SKU时：
   - 处理 kp2-20: productStatus.set('kp-20', {stockStatus: 'outofstock'})
   - 处理 kp5-20: productStatus.has('kp-20') === true → 跳过！❌

4. 判断是否需要同步：
   - kp-20 当前状态: 'outofstock' (只看到了kp2-20的状态)
   - ERP净库存: 0
   - 判断: outofstock && netStock <= 0 → 不需要同步 ❌

5. 结果：
   - kp5-20 (实际有货4个) 被完全遗漏
   - 没有任何同步操作
```

### 核心问题

**一对多映射时，只取第一个检测到的WC SKU状态来代表整个氚云SKU的状态，完全忽略了其他映射SKU可能处于不同状态。**

---

## 影响范围

### 受影响的文件

1. `src/app/api/sync/auto/route.ts` - 自动同步
2. `src/app/api/sync/site/route.ts` - 站点同步（同样的逻辑）

### 影响场景

- 任何一对多SKU映射的场景
- 当映射的多个WC SKU状态不一致时
- 特别是部分SKU已经正确同步，部分未同步的情况

---

## 修复方案

### 方案A: 检查所有映射SKU状态（推荐）

修改判断逻辑，对于一对多映射：
- 保留每个WC SKU的独立状态
- 只要有**任何一个**映射SKU状态与ERP不一致，就标记需要同步
- 同步时更新**所有**映射的WC SKU

```typescript
// 保留所有WC SKU的状态，不合并
const productStatusByWooSku = new Map<string, { stockStatus: string; isOnline: boolean }>();

// 判断时检查所有映射SKU
for (const item of siteInventoryData) {
  const sku = item.产品代码;
  const netStock = calculateNetStock(item);
  const wooSkus = h3yunToWooMap.get(sku) || [sku];

  let needSync = false;
  let targetStatus: 'instock' | 'outofstock' | null = null;

  // 检查所有映射的WC SKU
  for (const wooSku of wooSkus) {
    const status = productStatusByWooSku.get(wooSku);
    if (!status) continue;

    // 任何一个SKU状态不一致就需要同步
    if (status.stockStatus === 'instock' && netStock <= 0) {
      needSync = true;
      targetStatus = 'outofstock';
      break;
    }
    if (status.stockStatus === 'outofstock' && netStock > 0) {
      needSync = true;
      targetStatus = 'instock';
      break;
    }
  }

  // 同步所有映射的WC SKU...
}
```

### 方案B: 简化处理（保守方案）

对于一对多映射，**始终同步所有WC SKU**，不管当前状态：

```typescript
// 对于有映射的SKU，始终执行同步
if (wooSkus.length > 1) {
  needSync = true;
  targetStatus = netStock > 0 ? 'instock' : 'outofstock';
}
```

---

## 临时解决方案

在bug修复前，可以：

1. **手动同步**: 在/sync页面手动同步受影响的SKU
2. **检查映射SKU**: 定期检查一对多映射的SKU，确认所有WC SKU状态一致

---

## 验证方法

修复后验证步骤：

1. 找一个一对多映射的SKU（如kp-20 → kp2-20, kp5-20）
2. 手动将两个WC SKU设为不同状态（一个有货，一个无货）
3. 设置ERP库存为0
4. 运行自动同步
5. 验证两个WC SKU都被同步为无货

---

## 相关代码引用

- 检测逻辑: `src/app/api/sync/auto/route.ts:577-584`
- 同步逻辑: `src/app/api/sync/auto/route.ts:653-683`
- SKU映射构建: `src/app/api/sync/auto/route.ts:539-564`
- 站点同步（同样问题）: `src/app/api/sync/site/route.ts`