# 氚云字段映射更新总结

## 📅 更新时间
2025-01-21

## 🎯 更新目标
集成氚云 ERP 新增的库存字段，提高库存计算准确性。

## 🆕 新增氚云字段

| 字段ID | 字段名称 | 说明 | 逻辑关系 |
|--------|---------|------|---------|
| **F0000085** | 可售库存 | 氚云计算好的可售库存 | `= F0000030 - F0000055` |
| **F0000055** | 待出库 | 实际待出库数量 | 实际数据 |
| **F0000084** | 缺货排队待发 | 实际缺货数量 | 实际数据 |

## 📝 代码修改

### 1. 类型定义更新 (`src/lib/h3yun/types.ts`)

添加新字段到 `H3YunBizObject` 接口：

```typescript
F0000085: number;  // 可售库存 (= F0000030 - F0000055)
F0000055: number;  // 待出库
F0000084: number;  // 缺货排队待发
```

### 2. 字段映射逻辑更新 (`src/lib/h3yun/field-mappings.ts`)

#### 可售库存映射（优先级降级策略）
```typescript
可售库存: (obj: H3YunBizObject) => String(obj.F0000085 ?? obj.F0000030 ?? 0)
```
- 优先使用 F0000085（氚云计算好的可售库存）
- 降级使用 F0000030（可用SKU库存）
- 向后兼容旧数据

#### 净可售库存映射（三级降级策略）
```typescript
可售库存减去缺货占用库存: (obj: H3YunBizObject) => {
  if (obj.F0000085 !== undefined && obj.F0000085 !== null) {
    return String(obj.F0000085);  // 优先级1
  }
  if (obj.F0000083 !== undefined && obj.F0000083 !== null) {
    return String(obj.F0000083);  // 优先级2（向后兼容）
  }
  // 优先级3：降级计算
  const available = obj.F0000030 ?? 0;
  const pending = obj.F0000055 ?? 0;
  return String(available - pending);
}
```

#### 待出库和缺货字段
```typescript
// 旧版本：强制为 0（不准确）
缺货: () => '0',
待出库: () => '0',

// 新版本：使用实际数据
缺货: (obj: H3YunBizObject) => String(obj.F0000084 ?? 0),     // 缺货排队待发
待出库: (obj: H3YunBizObject) => String(obj.F0000055 ?? 0),   // 待出库
```

#### 可售总库存映射
```typescript
可售总库存: (obj: H3YunBizObject) => String(obj.F0000085 ?? obj.F0000030 ?? 0)
```

### 3. 数据验证逻辑更新

```typescript
// 旧版本
if (obj.F0000030 === undefined && obj.F0000083 === undefined) {
  missing.push('F0000030 或 F0000083 (库存数据)');
}

// 新版本（三级降级验证）
if (obj.F0000085 === undefined && obj.F0000083 === undefined && obj.F0000030 === undefined) {
  missing.push('F0000085 或 F0000083 或 F0000030 (库存数据)');
}
```

### 4. 修复所有映射函数的类型签名

所有返回常量的映射函数都添加了 `_obj: H3YunBizObject` 参数（使用下划线表示未使用），以符合 TypeScript 类型要求：

```typescript
// 示例
计划库存: (_obj: H3YunBizObject) => '0',
采购在途: (_obj: H3YunBizObject) => '0',
// ... 其他常量返回函数
```

## 📊 核心改进

### ✅ 数据准确性提升

| 字段 | 旧逻辑 | 新逻辑 | 改进 |
|-----|-------|-------|------|
| **可售库存** | F0000030（可用SKU库存） | **F0000085**（氚云计算值） ⭐ | 使用氚云计算好的值，更准确 |
| **待出库** | 强制为 0 ❌ | **F0000055**（实际值） ✅ | 反映真实待出库数量 |
| **缺货** | 强制为 0 ❌ | **F0000084**（实际值） ✅ | 反映真实缺货数量 |
| **净库存计算** | `可售库存 - 0` = 偏高 ❌ | `可售库存 - 实际缺货` ✅ | 计算结果更可靠 |

### 📈 向后兼容性

系统采用**降级策略**，确保：
- ✅ 新数据使用优先字段（F0000085）
- ✅ 旧数据自动降级到 F0000083 或 F0000030
- ✅ 没有数据丢失或错误

## 🔍 影响范围

### 受影响的功能模块

1. **库存同步** ([H3YunSyncPanel.tsx](src/components/inventory/H3YunSyncPanel.tsx))
   - 同步的库存数据现在更准确
   - 净库存计算包含真实缺货数据

2. **库存分析** ([inventory-utils.ts](src/lib/inventory-utils.ts))
   - `calculateNetStock()` 函数计算结果更准确
   - 同步建议逻辑基于更准确的库存数据

3. **产品同步** ([InventoryUpload.tsx](src/components/inventory/InventoryUpload.tsx))
   - WooCommerce 同步判断基于更准确的库存状态
   - 红色/蓝色按钮提示更可靠

## 📚 相关文档更新

- ✅ [H3YUN_INTEGRATION.md](docs/H3YUN_INTEGRATION.md) - 更新字段映射表和逻辑说明
- ✅ 添加"库存计算逻辑"章节
- ✅ 更新"数据准确性"注意事项

## 🧪 测试建议

### 1. 数据验证测试
```bash
# 测试氚云同步，验证新字段是否正确获取
npm run dev
# 访问库存管理页面 → 点击"同步库存"
```

### 2. 检查点
- [ ] F0000085 字段正确映射到"可售库存"
- [ ] F0000055 字段正确映射到"待出库"
- [ ] F0000084 字段正确映射到"缺货"
- [ ] 净库存计算 = 可售库存 - 缺货
- [ ] 降级逻辑在旧数据上正常工作

### 3. 对比测试
同步数据后，对比：
- 氚云 ERP 中的可售库存
- 系统显示的可售库存
- 系统计算的净可售库存

## ⚠️ 注意事项

1. **向后兼容**：如果氚云系统中某些记录没有新字段（F0000085/F0000055/F0000084），系统会自动降级到旧字段
2. **数据迁移**：建议氚云 ERP 中所有记录都补充新字段以获得最佳准确性
3. **类型检查**：修改后通过了 TypeScript 类型检查（只剩下项目原有的其他文件的类型错误）

## 🔗 相关 Commit

可以使用以下信息创建 Git Commit：

```bash
git add src/lib/h3yun/types.ts
git add src/lib/h3yun/field-mappings.ts
git add docs/H3YUN_INTEGRATION.md
git commit -m "feat: 集成氚云新增库存字段（F0000085/F0000055/F0000084）

- 新增字段定义：可售库存(F0000085)、待出库(F0000055)、缺货排队待发(F0000084)
- 更新字段映射逻辑，采用降级策略确保向后兼容
- 使用氚云计算好的可售库存值，提高数据准确性
- 净库存计算现包含真实缺货数据，不再强制为0
- 修复所有映射函数类型签名，通过TypeScript检查
- 更新文档，添加库存计算逻辑说明

Co-Authored-By: Claude <noreply@anthropic.com>"
```

## ✨ 效果对比

### 旧版本
```
可售库存 = F0000030 (可用SKU库存)
待出库 = 0 (强制)
缺货 = 0 (强制)
净库存 = 可售库存 - 0 = 偏高 ❌
```

### 新版本
```
可售库存 = F0000085 (氚云计算值) ⭐
待出库 = F0000055 (实际值) ✅
缺货 = F0000084 (实际值) ✅
净库存 = 可售库存 - 缺货 = 准确 ✅
```

---

**版本**: 1.1.0
**作者**: Claude Code
**审阅**: 待审阅
