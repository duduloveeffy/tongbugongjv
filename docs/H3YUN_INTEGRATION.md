# 氚云ERP库存集成使用指南

## 📋 概述

氚云ERP集成功能允许您直接从氚云ERP系统同步库存数据，替代手动CSV文件导入方式。

## 🎯 核心功能

- ✅ 一键从氚云ERP同步库存数据
- ✅ 自动字段映射和数据转换
- ✅ 连接测试功能
- ✅ 实时同步进度显示
- ✅ 配置持久化存储
- ✅ 自动品类映射同步

## 🚀 快速开始

### 1. 获取氚云API凭证

登录您的氚云ERP系统，获取以下信息：

- **Engine Code**: 类似 `t4yq7mzi2zpe1rnn6etflbvm0`
- **Engine Secret**: 类似 `dbdrlWeVK9U1WkIJwDZ2pMlrCLsCKK6Dh3/T4puiKLJ/muZjEecXTA==`
- **Schema Code**: 库存表的Schema Code，类似 `sirxt5xvsfeuamv3c2kdg`

### 2. 配置氚云连接

1. 打开库存管理页面
2. 找到"氚云ERP同步"卡片
3. 填写以下信息：
   - Engine Code
   - Engine Secret
   - Schema Code (库存表)
4. 点击"测试连接"按钮
5. 等待连接测试结果

### 3. 同步库存数据

连接测试成功后：

1. 点击"同步库存"按钮
2. 等待数据同步完成
3. 查看同步结果统计

## 📊 字段映射规则

### 核心字段映射

| 氚云字段 | 字段ID | 系统字段 | 说明 |
|---------|--------|---------|------|
| 产品SKU | F0000001 | 产品代码 | ⭐ 必需字段 |
| 数据标题 | Name | 产品名称 | 显示用 |
| **可售库存** | **F0000085** | **可售库存** | ⭐ 核心库存数据（优先使用） |
| 可用SKU库存 | F0000030 | 可售库存（降级） | 当F0000085不存在时使用 |
| 可售库存减去缺货占用库存 | F0000083 | 净可售库存（降级） | 向后兼容旧数据 |
| **待出库** | **F0000055** | **待出库** | ⭐ 实际待出库数量 |
| **缺货排队待发** | **F0000084** | **缺货** | ⭐ 实际缺货数量 |
| 所属仓库 | F0000007 | 仓库 | 需配置映射 |

### 拼接字段

**产品英文名称** = `尼古丁 (F0000063)` + `" - "` + `flavor (F0000064)`

示例：
- 尼古丁: `5%`
- flavor: `Blueberry Cherry Cola`
- 产品英文名称: `5% - Blueberry Cherry Cola`

### 品类字段

**一级品类** = `产品分类 (F0000003)`

**二级品类** = `产品分类 (F0000003)` + `" "` + `尼古丁 (F0000063)`

示例：
- 产品分类: `super`
- 尼古丁: `5%`
- 一级品类: `super`
- 二级品类: `super 5%`

**三级品类** = `空字符串`

### 库存计算逻辑

**可售库存优先级（向后兼容）：**
1. **F0000085**（可售库存）- 首选，氚云已计算好的值
2. F0000030（可用SKU库存）- 降级方案
3. 默认值 0

**净可售库存优先级：**
1. **F0000085**（可售库存）- 首选
2. F0000083（可用SKU库存不含待出库）- 兼容旧数据
3. 计算值：`F0000030 - F0000055` - 降级计算

**待出库：** 使用 **F0000055** 实际数据

**缺货：** 使用 **F0000084**（缺货排队待发）实际数据

✅ **更新说明**: 新版本使用氚云真实的缺货和待出库数据，净库存计算更准确。

## 🗂️ 仓库映射配置

### 问题说明

氚云API返回的 `F0000007` 是仓库ID而非名称，需要配置映射关系。

### 临时解决方案

首次同步后，如果仓库显示为ID（如 `a24b0be1-ad5d-48bb-a0a5-c6ccf126db86`），说明需要配置仓库映射。

### 配置仓库映射（未来功能）

1. 同步完成后查看库存数据
2. 记录显示的仓库ID
3. 在氚云同步面板中点击"配置仓库映射"
4. 手动添加 ID → 名称 的映射关系

示例：
```
ID: a24b0be1-ad5d-48bb-a0a5-c6ccf126db86
名称: 德七仓&QC-DE
代码: DS-DE
```

## 📁 文件结构

```
src/
├── lib/h3yun/
│   ├── types.ts                    # TypeScript类型定义
│   ├── field-mappings.ts           # 字段映射配置
│   ├── client.ts                   # API客户端
│   └── transformer.ts              # 数据转换器
├── app/api/h3yun/
│   ├── inventory/route.ts          # 库存同步API
│   └── test/route.ts               # 连接测试API
├── store/
│   └── h3yun.ts                    # 状态管理
└── components/inventory/
    ├── H3YunSyncPanel.tsx          # 同步面板组件
    └── InventoryUpload.tsx         # (已集成)
```

## 🔧 技术细节

### API调用流程

```
前端 → /api/h3yun/inventory → H3YunClient → 氚云API
                ↓
        数据转换 (transformer)
                ↓
        返回 InventoryItem[]
```

### 分页获取策略

- 默认每批获取1000条记录
- 自动分页直到获取所有数据
- 批次间延迟500ms防止API限流

### 数据验证

系统会自动验证必需字段：
- `F0000001` (产品SKU) 必须存在
- 库存数据至少有一个：`F0000085`（优先） 或 `F0000083` 或 `F0000030`

无效记录将被跳过并在日志中记录。

## 📊 同步结果统计

同步完成后会显示：
- **总记录数**: 从氚云获取的记录总数
- **有效记录**: 成功转换的记录数
- **跳过记录**: 因缺失必需字段而跳过的记录数
- **处理时间**: 数据转换耗时（毫秒）

## ⚠️ 注意事项

### 1. 数据准确性

- ✅ **新版本改进**: 系统现已支持氚云真实的库存数据（F0000085可售库存、F0000055待出库、F0000084缺货）
- ✅ **净库存计算准确**: 使用实际缺货数据，计算结果更可靠
- 📌 **向后兼容**: 如果新字段不存在，会自动降级到旧字段或计算值

### 2. 仓库映射

- 首次使用需配置仓库ID到名称的映射
- 映射配置存储在浏览器localStorage中
- 清除浏览器缓存会丢失映射配置

### 3. API限流

- 氚云API可能有调用频率限制
- 系统已内置延迟机制（批次间500ms）
- 如遇限流错误，请稍后重试

### 4. 数据同步频率

- 建议每日同步1-2次
- 避免短时间内频繁同步
- 大数据量（>5000条）可能需要较长时间

## 🐛 常见问题

### Q1: 连接测试失败

**可能原因:**
- Engine Code/Secret/Schema Code 填写错误
- 氚云API服务不可用
- 网络连接问题

**解决方案:**
1. 检查凭证是否正确
2. 确认氚云系统正常运行
3. 检查网络连接

### Q2: 仓库显示为ID

**原因:** 缺少仓库映射配置

**解决方案:**
1. 记录显示的仓库ID
2. 手动配置 ID → 名称 映射
3. 重新同步数据

### Q3: 部分数据被跳过

**原因:** 记录缺少必需字段（产品SKU或库存数据）

**解决方案:**
1. 查看浏览器控制台日志
2. 确认跳过的记录是否有效
3. 在氚云ERP中补充缺失字段

### Q4: 产品英文名称显示异常

**原因:** 氚云数据中尼古丁或flavor字段为空

**说明:** 系统会自动处理：
- 两者都为空 → 使用产品名称或SKU
- 一个为空 → 使用非空的那个
- 两者都有 → 拼接为 "尼古丁 - flavor"

## 🔄 与CSV导入对比

| 特性 | 氚云同步 | CSV导入 |
|-----|---------|--------|
| 操作便捷性 | ⭐⭐⭐⭐⭐ 一键同步 | ⭐⭐⭐ 需要导出上传 |
| 数据实时性 | ⭐⭐⭐⭐⭐ 实时获取 | ⭐⭐⭐ 依赖导出时间 |
| 字段完整性 | ⭐⭐⭐⭐ 大部分字段 | ⭐⭐⭐⭐⭐ 所有字段 |
| 配置复杂度 | ⭐⭐⭐ 需配置仓库映射 | ⭐⭐⭐⭐⭐ 无需配置 |
| 错误处理 | ⭐⭐⭐⭐ 自动验证和提示 | ⭐⭐⭐ 手动检查 |

## 📚 相关文档

- [氚云API官方文档](https://www.h3yun.com/OpenApi)
- [库存分析系统使用指南](../README.md)
- [字段映射详细说明](./FIELD_MAPPINGS.md)

## 🆘 技术支持

如遇到问题，请提供以下信息：
1. 浏览器控制台错误日志
2. 氚云配置信息（请脱敏）
3. 同步失败的具体步骤
4. 跳过记录的SKU示例

---

**版本**: 1.0.0
**更新时间**: 2025-01-XX
**作者**: Claude Code
