# 氚云同步调试指南

## 📋 增强的日志输出

现在系统在后端Terminal输出详细的同步日志，帮助诊断数据获取问题。

---

## 🔍 如何查看日志

### 1. 启动开发服务器

```bash
npm run dev
```

### 2. 进行同步操作

在浏览器中打开库存管理页面，点击"同步库存"按钮

### 3. 查看Terminal输出

切换到运行 `npm run dev` 的Terminal窗口，您将看到详细的日志输出

---

## 📊 日志输出示例

### 正常情况（1510条记录）

```
[H3Yun Sync] 开始同步库存数据
[H3Yun Client] 开始分页获取数据，每批 1000 条
[H3Yun Client] 第 1 批：请求 fromRow=0, toRow=1000
[H3Yun Client] 第 1 批：实际返回 1000 条记录
[H3Yun Client] 当前累计获取: 1000 条记录
[H3Yun Client] 第 2 批：请求 fromRow=1000, toRow=2000
[H3Yun Client] 第 2 批：实际返回 510 条记录
[H3Yun Client] 第 2 批：返回 510 < 1000，已到最后一批
[H3Yun Client] 当前累计获取: 1510 条记录
[H3Yun Client] 分页获取完成，共 2 批，总计 1510 条记录
[H3Yun Sync] 获取到 1510 条氚云记录
[H3Yun Transformer] 开始转换 1510 条氚云记录
[H3Yun Transformer] 转换完成: 总计1510条, 有效1510条, 跳过0条, 耗时45ms
[H3Yun Sync] 转换完成: 1510 有效记录, 0 跳过
```

### 问题情况A：第2批只返回500条（氚云API限制）

```
[H3Yun Client] 开始分页获取数据，每批 1000 条
[H3Yun Client] 第 1 批：请求 fromRow=0, toRow=1000
[H3Yun Client] 第 1 批：实际返回 1000 条记录
[H3Yun Client] 当前累计获取: 1000 条记录
[H3Yun Client] 第 2 批：请求 fromRow=1000, toRow=2000
[H3Yun Client] 第 2 批：实际返回 500 条记录  ⚠️ 少于预期510条
[H3Yun Client] 第 2 批：返回 500 < 1000，已到最后一批
[H3Yun Client] 当前累计获取: 1500 条记录  ⚠️ 总计少了10条
[H3Yun Client] 分页获取完成，共 2 批，总计 1500 条记录
```

**诊断**: 氚云API对单次请求有500条限制，需要调整pageSize

### 问题情况B：只执行1批（分页逻辑失败）

```
[H3Yun Client] 开始分页获取数据，每批 1000 条
[H3Yun Client] 第 1 批：请求 fromRow=0, toRow=1000
[H3Yun Client] 第 1 批：实际返回 500 条记录  ⚠️ 远少于1000
[H3Yun Client] 第 1 批：返回 500 < 1000，已到最后一批  ⚠️ 误判为最后一批
[H3Yun Client] 当前累计获取: 500 条记录
[H3Yun Client] 分页获取完成，共 1 批，总计 500 条记录
```

**诊断**: 第1批就只返回500条，说明氚云单次请求限制是500条

### 问题情况C：数据验证过严（大量跳过）

```
[H3Yun Client] 分页获取完成，共 2 批，总计 1510 条记录
[H3Yun Sync] 获取到 1510 条氚云记录  ✅ 获取正常
[H3Yun Transformer] 开始转换 1510 条氚云记录
[H3Yun Transformer] 转换完成: 总计1510条, 有效500条, 跳过1010条  ⚠️ 大量跳过
[H3Yun Sync] 转换完成: 500 有效记录, 1010 跳过
```

**诊断**: 数据获取正常，但转换时有1010条被跳过，需要放宽验证规则

---

## 🎯 根据日志诊断问题

### 场景1: 氚云API有500条限制

**日志特征**:
- 每批实际返回都不超过500条
- 第1批: `实际返回 500 条记录`
- 第2批: `实际返回 500 条记录`
- ...

**解决方案**: 调整pageSize为500

### 场景2: 第1批就结束了

**日志特征**:
- 只看到"第 1 批"
- `分页获取完成，共 1 批，总计 500 条记录`

**解决方案**:
1. 检查氚云API返回的数据结构是否正确
2. 调整pageSize为500
3. 检查是否有权限访问全部数据

### 场景3: 数据被大量跳过

**日志特征**:
- `获取到 1510 条氚云记录` ✅
- `有效500条, 跳过1010条` ❌

**解决方案**: 查看控制台的警告日志，了解哪些字段缺失导致跳过

---

## 🔧 修复方案

### 方案A: 调整pageSize为500（推荐）

如果日志显示每批最多返回500条，执行以下修改：

#### 修改1: `src/lib/h3yun/client.ts`

第90行：
```typescript
// 从
async fetchAllInventory(pageSize = 1000, ...)

// 改为
async fetchAllInventory(pageSize = 500, ...)
```

#### 修改2: `src/app/api/h3yun/inventory/route.ts`

第9行：
```typescript
// 从
const { config, warehouseMappings, pageSize = 1000 }

// 改为
const { config, warehouseMappings, pageSize = 500 }
```

#### 修改3: `src/components/inventory/H3YunSyncPanel.tsx`

第118行：
```typescript
// 从
pageSize: 1000,

// 改为
pageSize: 500,
```

### 方案B: 放宽数据验证

如果大量数据被跳过，检查 `src/lib/h3yun/field-mappings.ts` 中的 `validateH3YunData` 函数

---

## 📝 日志字段说明

| 日志标记 | 含义 |
|---------|------|
| `[H3Yun Sync]` | API路由层日志 |
| `[H3Yun Client]` | 氚云API客户端日志 |
| `[H3Yun Transformer]` | 数据转换器日志 |

| 关键数据 | 说明 |
|---------|------|
| `fromRow` | 请求的起始行号（从0开始） |
| `toRow` | 请求的结束行号（不包含） |
| `实际返回 X 条` | 氚云API实际返回的记录数 |
| `当前累计获取` | 已获取的总记录数 |
| `总计X条` | 从氚云获取的记录总数 |
| `有效X条` | 转换成功的记录数 |
| `跳过X条` | 因缺失必需字段被跳过的记录数 |

---

## 🆘 常见问题诊断表

| 症状 | 可能原因 | 解决方案 |
|-----|---------|---------|
| 只获取500条 | 氚云API限制500条/批 | 调整pageSize为500 |
| 只有1批请求 | 第1批返回数<1000触发退出 | 调整pageSize为500 |
| 获取1510但只有500有效 | 数据验证过严 | 放宽验证规则 |
| 第2批返回0条 | 数据已全部获取 | 正常情况，无需处理 |
| 每批都是500条整 | 氚云API限制 | 调整pageSize匹配限制 |

---

## 📊 性能指标

**正常情况（1510条，pageSize=1000）**:
- 批次数: 2批
- 总耗时: ~2-3秒
- 转换耗时: ~50ms

**调整后（1510条，pageSize=500）**:
- 批次数: 4批
- 总耗时: ~4-5秒（多了延迟）
- 转换耗时: ~50ms

---

## 🎯 下一步

**请执行以下操作**:

1. ✅ 重启开发服务器: `npm run dev`
2. ✅ 打开库存管理页面
3. ✅ 点击"同步库存"
4. ✅ 查看Terminal输出的日志
5. ✅ 将完整的日志复制给我

**日志应该包含**:
```
[H3Yun Sync] 开始同步库存数据
[H3Yun Client] 开始分页获取数据...
[H3Yun Client] 第 1 批：请求...
[H3Yun Client] 第 1 批：实际返回...
...
[H3Yun Client] 分页获取完成...
[H3Yun Sync] 获取到 XXX 条氚云记录
[H3Yun Transformer] 转换完成...
```

根据这些日志，我可以准确诊断问题并提供精确的修复方案。

---

**文档版本**: 1.1.0
**更新时间**: 2025-01-XX
**作者**: Claude Code
