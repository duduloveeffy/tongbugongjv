# 品类趋势显示为0问题解决方案

## 问题描述
SKU销售趋势正常显示，但对应的品类趋势线显示为0。

## 根本原因
1. **缓存问题**: Redis缓存了旧的数据（品类映射修复前的数据）
2. **品类映射**: 品类映射表需要包含所有相关SKU

## 解决步骤

### 立即解决方法

#### 方法1: 清理缓存（推荐）
```bash
# 清理品类相关缓存
node clear-redis-cache.js

# 或清理所有缓存
node clear-redis-cache.js --all
```

#### 方法2: 刷新页面
清理缓存后，刷新浏览器页面，趋势图会重新加载最新数据。

### 长期解决方案

#### 1. 重新上传库存文件
- 在"库存分析"页面
- 上传最新的库存CSV文件
- 系统会自动同步品类映射

#### 2. 手动同步品类
```bash
node sync-inventory-categories.js
```

## 验证修复

### 检查品类映射
```bash
node debug-jnr1802-01.js
```

### 测试API响应
```bash
node test-category-api.js
```

正确的响应应该显示：
- 总销量 > 0
- 趋势数据包含实际销量

## 技术细节

### 缓存策略
- 品类趋势数据缓存6小时
- 缓存键格式: `trends:category:{品类}:{周期}:{天数}:{站点}`

### 数据流
1. 用户上传库存文件
2. 系统提取SKU和品类映射
3. 同步到 `product_categories` 表
4. 品类查询函数使用映射关联销售数据
5. 前端展示趋势图

### 重要文件
- `/src/app/api/sales/trends/category/route.ts` - 品类趋势API
- `/src/lib/redis-cache.ts` - 缓存管理
- `/supabase/migrations/20250810_fix_category_mapping_site_issue.sql` - 数据库修复

## 常见问题

### Q: 为什么清理缓存后就正常了？
A: 缓存保存了品类映射修复前的数据。清理后会重新从数据库获取最新数据。

### Q: 需要定期清理缓存吗？
A: 不需要。正常情况下缓存会自动过期（6小时）。只有在数据结构修改后才需要手动清理。

### Q: 如何确认品类映射是否正确？
A: 运行 `node debug-jnr1802-01.js` 查看品类下的SKU列表。

## 预防措施
1. 定期更新库存文件以保持品类映射最新
2. 数据结构变更后主动清理相关缓存
3. 监控品类趋势数据的准确性